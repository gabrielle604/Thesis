---
title: "April_Draft"
output: html_document
date: "2023-04-04"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(ggpubr) # for some graphic applications that extend ggplot2
library(janitor)
library(broom) # used to make tables
library(knitr) # used to make table
library(car) # has leveneTest 
library(foreign) # to read in NHANES data
library(rstanarm) # for the model fitting
library(jtools) # Load jtools, for forest plots
library(sandwich) # needed for robust standard errors in forest plot
library(huxtable) # needed to be able to export table of forest plot values
library(broom.mixed) # used in making tables
library(visdat)
library(ggplot2)

library(haven) # for reading SAS XPT file from NHANES website
library(survey) # for using survey weights
library(dplyr) # for data wrangling
library(forcats)
library(skimr)
library(stringr)
library(gtsummary)

library(remotes)
library(svrepmisc)

library(olsrr)
library(ggplot2)
library(gridExtra)
library(nortest)
library(goftest)

library(ggcorrplot)


```


## Load the data
```{r}
NHANES <- read_csv(here("cleaned_data","NHANES.csv"))
```


## The svydesign function
Before we can start our analyses, we need to use the svydesign function from the "survey" package written by Thomas Lumley. The svydesign function tells R about the design elements in the survey. Once this command has been issued, all that needs to be done for the analyses is use the object that contains this information in each command. Because the 2001-2016 NHANES data were released with a sampling weight (wtint2yr), a PSU variable (sdmvpsu) and a strata variable (sdmvstra), we will use these our svydesign function.

```{r}
nhc <- svydesign(id=~SDMVPSU, weights=~WTINT2YR,strata=~SDMVSTRA, nest=TRUE, survey.lonely.psu = "adjust", data=NHANES)
nhc
```


## We can get additional information about the sample, such as the number of PSUs per strata, by using the summary function.
```{r}
summary(nhc)
```










## Boxplots, bivariate analyses
```{r}
# change the noNAs dataset with each boxplot I create:
## one for: refED age gender ethnicity fpl citizenship

noNAs = NHANES %>% filter(!is.na(citizenship)) %>% filter(!is.na(monoEthyl))
                                                                                                            

box_citizenship <- ggplot(data = noNAs, design=nhc,
                      aes(x=log(monoEthyl), y=citizenship, fill=citizenship)) +
  scale_fill_brewer(palette="PuBuGn") +
  geom_boxplot() +
  theme(text = element_text(size=12)) +
  xlab("(logged) Mono-Ethyl Phthalate Level (ng/mL)") +
  ylab("Participant Citizenship Status") +
ggtitle("Participant Citizenship Status and Logged Phthalate Level")


box_citizenship
```
We can make barcharts. In the example below, we also preview some syntax used for subpopulation analysis.
```{r}
barplt<-svyby(~log(monoEthyl)+RIDAGEYR, ~gender, nhc, na = TRUE, svymean)
barplot(barplt,beside=TRUE,legend=TRUE)
```
## We can break the boxplot by a grouping variable. The grouping variable must be a factor.
```{r}
svyboxplot(~log(monoEthyl)~factor(gender), nhc, all.outliers=TRUE)
```
## Instead of the density on the y-axis, we can request the count.  Notice the large count of respondents in the last column on the right.  The coding of the ridageyr variable explains this.
```{r}
svyhist(~RIDAGEYR, nhc, probability = FALSE)
```











## REORDER year
```{r}
NHANES$year <- factor(NHANES$year, ordered = TRUE)
NHANES$year
```

## Boxplots, bivariate analyses --- year
```{r}
# change the noNAs dataset with each boxplot I create:
## one for: refED age gender ethnicity fpl citizenship

noNAs = NHANES %>% filter(!is.na(year)) %>% filter(!is.na(monoEthyl))
                                                                                                            

box_year <- ggplot(data = noNAs, design=nhc,
                      aes(x=log(monoEthyl), y=year, fill=year)) +
  scale_fill_brewer(palette="PuBuGn") +
  geom_boxplot() +
  theme(text = element_text(size=12)) +
  xlab("(logged) Mono-Ethyl Phthalate Level (ng/mL)") +
  ylab("Year of Participant Survey") +
ggtitle("Year of Participant Survey and Logged Phthalate Level")

box_year
```










## ADULTS Subpopulation Analysis
```{r}
subset_adult <- subset(nhc, RIDAGEYR >= 19)

# create an adult NHANES file
names(NHANES)

NHANES %>% filter(RIDAGEYR>=19) -> only_adults
```


### What is missing?
```{r}
vis_miss(only_adults, sort_miss = TRUE)
```


### Model for Adults
```{r}
model_adult <- svyglm(log(monoEthyl)~age+gender+ethnicity+fpl+citizenship+adultED+year, design=subset_adult, na.action = na.omit)

summ(model_adult)

summ(model_adult, robust = "HC1") #robust standard errors 

summ(model_adult, confint = TRUE, digits = 3) #In many cases, you’ll learn more by looking at confidence intervals than p-values. You can request them from summ. default is 95% CIs

summ(model_adult, confint = TRUE, pvals = FALSE) #DROP the p values all together

# THE GRAPH
plot_summs(model_adult)
plot_summs(model_adult, inner_ci_level = .95)
plot_summs(model_adult, robust = TRUE)

# plot coefficient uncertainty as normal distributions
plot_summs(model_adult, plot.distributions = TRUE, inner_ci_level = .95)

# table output for Word and RMarkdown documents
## error is in the parenthesis
export_summs(model_adult, scale = TRUE)

# confidence intervals instead of standard errors
export_summs(model_adult, scale = TRUE,
             error_format = "[{conf.low}, {conf.high}]")
```


### Renaming the forest plot labels
```{r}
forest_adult <- plot_summs(
        point.size = 3,
        fontsize=8,
        colors = "darkslateblue",
        model_adult, coefs = c("Age: Older Adult
                                 Middle-Aged (ref)" = "ageolder adult",
                          
                                 "Age: Young Adult
                                 Middle-Aged (ref)" = "ageyoung adult",
                          
                                 "Gender: Male
                                 Gender: Female (ref)" = "gendermale",
                          
                                 "Ethnicity: Non-Hispanic Black
                                 Mexican American (ref)" = "ethnicityNon-Hispanic Black",
                          
                                 "Ethnicity: Non-Hispanic White
                                 Mexican American (ref)" = "ethnicityNon-Hispanic White",
                          
                                 "Ethnicity: Other Hispanic
                                 Mexican American (ref)" = "ethnicityOther Hispanic",
                          
                                 "Ethnicity: Other or Multi
                                 Mexican American (ref)" = "ethnicityOther or Multi",
                          
                                 "Family Income to Poverty Ratio: 2x Poverty threshold
                                 At poverty threshold (ref)" = "fplfamily income 2x poverty threshold",
                          
                                 "Family Income to Poverty Ratio: 3x Poverty threshold
                                 At poverty threshold (ref)" = "fplfamily income 3x poverty threshold",
                          
                                 "Family Income to Poverty Ratio: 4x Poverty threshold
                                 At poverty threshold (ref)" = "fplfamily income 4x poverty threshold",
                          
                                 "Family Income to Poverty Ratio: 5x Poverty threshold
                                 At poverty threshold (ref)" = "fplfamily income 5x poverty threshold",
                          
                                 "Family Income to Poverty Ratio: more than 5x Poverty threshold
                                 At poverty threshold (ref)" = "fplfamily income more than 5x poverty threshold",
                          
                                 "Citizenship Status: Not U.S. Citizen
                                 U.S. Citizen by birth or naturalization (ref)" = "citizenshipnot U,S, citizen",
        
                                 "Participant Education: High School Grad/GED
                                  College Grad or Above (ref)" = "adultEDhigh school grad/GED",
        
                                 "Participant Education: Less than High School/GED
                                  College Grad or Above (ref)" = "adultEDless than HS/GED",
        
                                 "Participant Education: Some College or AA
                                  College Grad or Above (ref)" = "adultEDsome college or AA",
        
                                 "Year of Survey" = "year"),
                               
                          scale = TRUE, robust = TRUE)

forest_adult
```


### Comparing AICs
```{r}
ols_adult <- (svyglm(log(monoEthyl)~age+gender+ethnicity+fpl+citizenship+adultED+year, design=subset_adult, na.action = na.omit))
ols_adult
# this gives an AIC of 49,140

# without year
ols_adult <- (svyglm(log(monoEthyl)~age+gender+ethnicity+fpl+citizenship+adultED, design=subset_adult, na.action = na.omit))
ols_adult
# this gives an AIC of 50,530

# with refED, not adultED
ols_adult <- (svyglm(log(monoEthyl)~age+gender+ethnicity+fpl+citizenship+refED+year, design=subset_adult, na.action = na.omit))
ols_adult
# this gives an AIC of 49,610
```










## Children Subpopulation Analysis
```{r}
subset_child <- subset(nhc, RIDAGEYR < 19)

# create a child NHANES file
names(NHANES)

NHANES %>% filter(RIDAGEYR<19) -> only_child
```


### What is missing?
```{r}
vis_miss(only_child, sort_miss = TRUE)
```

### Model for Children
```{r}
model_child <- svyglm(log(monoEthyl)~refED+RIDAGEYR+gender+ethnicity+fpl+citizenship+year, design=subset_child, na.action = na.omit)
## using continuous RIDAGEYR rather than "age" categories, since all are children

summ(model_child)

summ(model_child, robust = "HC1") #robust standard errors 

summ(model_child, confint = TRUE, digits = 3) #In many cases, you’ll learn more by looking at confidence intervals than p-values. You can request them from summ. default is 95% CIs

summ(model_child, confint = TRUE, pvals = FALSE) #DROP the p values all together

# THE GRAPH
plot_summs(model_child)
plot_summs(model_child, inner_ci_level = .95)
plot_summs(model_child, robust = TRUE)

# plot coefficient uncertainty as normal distributions
plot_summs(model_child, plot.distributions = TRUE, inner_ci_level = .95)

# table output for Word and RMarkdown documents
## error is in the parenthesis
export_summs(model_child, scale = TRUE)

# confidence intervals instead of standard errors
export_summs(model_child, scale = TRUE,
             error_format = "[{conf.low}, {conf.high}]")
```


### Renaming the forest plot labels
```{r}
forest_child <- plot_summs(
        point.size = 3,
        fontsize=8,
        colors = "skyblue3",
        model_child, coefs = c("Household Education Partial College and Below
                                 College and Beyond (ref)" = "refEDpartial college and below", 
                          
                                 "Age in years (continuous)
                                 (mean-centered and scaled by 1 SD)" = "RIDAGEYR",
                               
                                 "Gender: Male
                                 Gender: Female (ref)" = "gendermale",
                          
                                 "Ethnicity: Non-Hispanic Black
                                 Mexican American (ref)" = "ethnicityNon-Hispanic Black",
                          
                                 "Ethnicity: Non-Hispanic White
                                 Mexican American (ref)" = "ethnicityNon-Hispanic White",
                          
                                 "Ethnicity: Other Hispanic
                                 Mexican American (ref)" = "ethnicityOther Hispanic",
                          
                                 "Ethnicity: Other or Multi
                                 Mexican American (ref)" = "ethnicityOther or Multi",
                          
                                 "Family Income to Poverty Ratio: 2x Poverty threshold
                                 At poverty threshold (ref)" = "fplfamily income 2x poverty threshold",
                          
                                 "Family Income to Poverty Ratio: 3x Poverty threshold
                                 At poverty threshold (ref)" = "fplfamily income 3x poverty threshold",
                          
                                 "Family Income to Poverty Ratio: 4x Poverty threshold
                                 At poverty threshold (ref)" = "fplfamily income 4x poverty threshold",
                          
                                 "Family Income to Poverty Ratio: 5x Poverty threshold
                                 At poverty threshold (ref)" = "fplfamily income 5x poverty threshold",
                          
                                 "Family Income to Poverty Ratio: more than 5x Poverty threshold
                                 At poverty threshold (ref)" = "fplfamily income more than 5x poverty threshold",
                          
                                 "Citizenship Status: Not U.S. Citizen
                                 U.S. Citizen by birth or naturalization (ref)" = "citizenshipnot U,S, citizen",
                               
                                 "Year of Survey" = "year"),
        
                          scale = TRUE, robust = TRUE)

forest_child
```


### Comparing AICs
```{r}
ols_child <- svyglm(log(monoEthyl)~refED+RIDAGEYR+gender+ethnicity+fpl+citizenship+year, design=subset_child, na.action = na.omit)
ols_child 
# this gives an AIC of 23,580

## without year
ols_child <- svyglm(log(monoEthyl)~refED+RIDAGEYR+gender+ethnicity+fpl+citizenship, design=subset_child, na.action = na.omit)
ols_child 
# this gives an AIC of 24,430
```










## Descriptive Statistics table info: CHILDREN
```{r}
summary(as.factor(NHANES$gender))

svysd(~RIDAGEYR, design = subset_child, na = TRUE)

svymean(~log(URXMEP), design = subset_child, na = TRUE)
svysd(~log(URXMEP), design = subset_child, na = TRUE)

svymean(~RIDAGEYR, design = subset_child, na = TRUE)

svymean(~RIDAGEYR, design = subset_adult, na = TRUE)

svymean(~INDFMPIR, nhc, na = TRUE)

# descriptive statistics with categorical variables (replace ~fpl with each variable individually)
## children
table1 <- svytable(~fpl, design = subset_child)

prop.table(table1)

# adults
table2 <- svytable(~age, design = subset_adult)

prop.table(table2)
```










## Descriptive Statistics table info: ADULTS
```{r}
summary(as.factor(NHANES$gender))

svysd(~RIDAGEYR, design = subset_adult, na = TRUE)

svymean(~log(URXMEP), design = subset_adult, na = TRUE)

svymean(~RIDAGEYR, design = subset_adult, na = TRUE)

svymean(~INDFMPIR, nhc, na = TRUE)

# descriptive statistics with categorical variables (replace ~fpl with each variable individually)
## children
table1 <- svytable(~age, design = subset_child)

prop.table(table1)

# adults
table2 <- svytable(~fpl, design = subset_adult)

prop.table(table2)
```









## Chi Squared Test
very small p value ->> reject the idea that they are equal
```{r}
svychisq(~ethnicity+gender, nhc, statistic="adjWald")
```










## Independent-samples t-test:
```{r}
svyttest(log(monoEthyl)~gender, nhc)
```










## ANOVA
This is an example of a Kruskal Wallis test, which is the non-parametric analog of a one-way ANOVA.

Null Hypothesis (H0): All ranks are equal (no difference in medians) 
Alternative Hypothesis (HA): At least two ranks differ (at least one difference in group medians)

Tests whether samples are originated from the same distribution.
The ANOVA (and t-test) is explicitly a test of equality of means of values. The Kruskal-Wallis (and Mann-Whitney) can be seen technically as a comparison of the mean ranks

NOTE: the "Chisq" is actually the H Statistic
```{r}
kwtest <- svyranktest(monoEthyl~adultED, design = nhc, na = TRUE, test=("KruskalWallis"))
kwtest
```










## Distribution of Mono-ethyl Phthalate
```{r}
## raw
hist(NHANES$monoEthyl, col = 'skyblue3', border = "white", xlab = 'Mono-ethyl Phthalate (ng/mL)', ylab = 'Frequency', main = 'Distribution of Mono-ethyl Phthalate')

## raw, just children
hist(only_child$monoEthyl, col = 'skyblue3', border = "white", breaks = 50, xlab = 'Mono-ethyl Phthalate (ng/mL)', ylab = 'Frequency', main = 'Distribution of Mono-ethyl Phthalate')

## dotchart
dotchart(only_child$monoEthyl, col = 'skyblue3', col.line = "transparent", xlab = 'Mono-ethyl Phthalate (ng/mL)', ylab = 'Frequency', main = 'Distribution of Mono-ethyl Phthalate')

ggplot(only_child,aes(monoEthyl))+geom_dotplot(binwidth=100)+theme_minimal()


## logged
hist(log(NHANES$URXMEP), col = 'skyblue3', border = "white", xlab = 'Mono-ethyl Phthalate (ng/mL)', ylab = 'Frequency', main = 'Distribution of Mono-ethyl Phthalate')

## logged, just children
hist(log(only_child$URXMEP), col = 'skyblue3', border = "white", xlab = 'Mono-ethyl Phthalate (ng/mL)', ylab = 'Frequency', main = 'Distribution of Mono-ethyl Phthalate')

## density plot
dens1<-svysmooth(~log(monoEthyl), design=nhc)
plot(dens1)

## Scatterplot with the sampling weights corresponding to the bubble size.
svyplot(~log(monoEthyl)+RIDAGEYR, nhc, style="bubble")
```










## Descriptive statistics table: CHILDREN
```{r}
skim(NHANES)

only_child$ageCont <- only_child$RIDAGEYR
only_child$LOGmonoEthyl <- log(only_child$URXMEP)


only_child %>% tabyl(age, gender)

only_child %>% 
  select(RIDAGEYR,URXMEP) %>%  # keep only columns of interest
  tbl_summary(                                     # create summary table
    type = all_continuous() ~ "continuous2",       # indicate that you want to print multiple statistics 
    statistic = all_continuous() ~ c(
      "{mean} ({sd})",                             # line 1: mean and SD
      "{median} ({p25}, {p75})",                   # line 2: median and IQR
      "{min}, {max}")                              # line 3: min and max
    )

only_child %>% 
  select(age, ageCont, gender, ethnicity, fpl, citizenship, refED, LOGmonoEthyl) %>%  # keep only columns of interest
  tbl_summary(                                     # create summary table
    type = all_continuous() ~ "continuous2",       # indicate that you want to print multiple statistics 
    statistic = all_continuous() ~ c(
      "{mean} ({sd})",                             # line 1: mean and SD
      "{median} ({p25}, {p75})",                   # line 2: median and IQR
      "{min}, {max}")                              # line 3: min and max
    )
```










## Descriptive statistics table: ADULTS
```{r}
skim(NHANES)

only_adults$ageCont <- only_adults$RIDAGEYR
only_adults$LOGmonoEthyl <- log(only_adults$URXMEP)


only_adults %>% tabyl(age, gender)

only_adults %>% 
  select(RIDAGEYR,URXMEP) %>%  # keep only columns of interest
  tbl_summary(                                     # create summary table
    type = all_continuous() ~ "continuous2",       # indicate that you want to print multiple statistics 
    statistic = all_continuous() ~ c(
      "{mean} ({sd})",                             # line 1: mean and SD
      "{median} ({p25}, {p75})",                   # line 2: median and IQR
      "{min}, {max}")                              # line 3: min and max
    )

only_adults %>% 
  select(age, ageCont, gender, ethnicity, fpl, citizenship, refED, adultED, LOGmonoEthyl) %>%  # keep only columns of interest
  tbl_summary(                                     # create summary table
    type = all_continuous() ~ "continuous2",       # indicate that you want to print multiple statistics 
    statistic = all_continuous() ~ c(
      "{mean} ({sd})",                             # line 1: mean and SD
      "{median} ({p25}, {p75})",                   # line 2: median and IQR
      "{min}, {max}")                              # line 3: min and max
    )
```










## Collinearity of reference person education and adult participant education
```{r}
model <- lm(log(monoEthyl)~age+gender+ethnicity+fpl+citizenship+adultED+refED+year, design=subset_adult, data = only_adults)
ols_coll_diag(model)
# how do I interpret that ^^^ ???

## another approach
### standard errors tend to inflate (get bigger) when there are collinear variables
summary(lm(log(monoEthyl)~age+gender+ethnicity+fpl+citizenship+adultED+year, design=subset_adult, data = only_adults))

summary(lm(log(monoEthyl)~age+gender+ethnicity+fpl+citizenship+adultED+refED+year, design=subset_adult, data = only_adults))
# coefficients for adultED go down when refED added into the model
```

## We can confirm that they are relatively highly correlated
```{r}
model.matrix(~0+., data=only_adults) %>% 
  cor(use="pairwise.complete.obs") %>% 
  ggcorrplot(show.diag=FALSE, type="lower", lab=TRUE, lab_size=2)
# ^that's crazy looking. let's simplify it
```

## Only looking at correlation between adult participant education and household head education

If you want to have a genuine correlation plot for factors or mixed-type, you can also use model.matrix to one-hot encode all non-numeric variables. This is quite different than calculating Cramér's V as it will consider your factor as separate variables, as many regression models do.

You can then use your favorite correlation-plot library. I personally like ggcorrplot for its ggplot2 compatibility.

Source: https://stackoverflow.com/questions/52554336/plot-the-equivalent-of-correlation-matrix-for-factors-categorical-data-and-mi
```{r}
only_adults_edu <- only_adults %>% select(adultED,refED)

model.matrix(~0+., data=only_adults_edu) %>% 
  cor(use="pairwise.complete.obs") %>% 
  ggcorrplot(show.diag=FALSE, type="lower", lab=TRUE, lab_size=2)
```







