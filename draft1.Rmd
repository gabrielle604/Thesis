---
title: "draft1"
output: html_document
date: "2023-02-16"
output: 
  html_document:
    code_folding: hide
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(ggpubr) # for some graphic applications that extend ggplot2
library(janitor)
library(broom) # used to make tables
library(knitr) # used to make table
library(car) # has leveneTest 
library(foreign) # to read in NHANES data
library(rstanarm) # for the model fitting
library(jtools) # Load jtools, for forest plots
library(sandwich) # needed for robust standard errors in forest plot
library(huxtable) # needed to be able to export table of forest plot values
library(broom.mixed) # used in making tables
library(visdat)
library(ggplot2)

library(haven) # for reading SAS XPT file from NHANES website
library(survey) # for using survey weights
library(dplyr) # for data wrangling
library(forcats)

#install.packages("remotes")
#remotes::install_github("carlganz/svrepmisc")

library("remotes")
library("svrepmisc")

```

## Load the data
```{r}
fullNHANES_recat <- read_csv(here("cleaned_data","fullNHANES_recat.csv"))
```
## The svydesign function

Before we can start our analyses, we need to use the svydesign function from the “survey” package written by Thomas Lumley. The svydesign function tells R about the design elements in the survey. Once this command has been issued, all that needs to be done for the analyses is use the object that contains this information in each command. Because the 2001-2016 NHANES data were released with a sampling weight (wtint2yr), a PSU variable (sdmvpsu) and a strata variable (sdmvstra), we will use these our svydesign function. 

```{r}
nhc <- svydesign(id=~SDMVPSU, weights=~WTINT2YR,strata=~SDMVSTRA, nest=TRUE, survey.lonely.psu = "adjust", data=fullNHANES_recat)
nhc
```

## We can get additional information about the sample, such as the number of PSUs per strata, by using the summary function.

```{r}
summary(nhc)
```

## Descriptive statistics with continuous variables

### We can also get the standard deviation of the age variable. We use the function svysd, which is found in the jtools package.

- When there are missing data for a variable, the na = TRUE argument is needed.

## The means of more than one variable can be obtained by placing “+” between the variables. Notice that a listwise deletion has been done, so that the means in output below are different from the means shown above.

```{r}
svymean(~RIDAGEYR, nhc)

svymean(~RIDAGEYR + URXMEP + INDFMPIR + fpl,design = nhc, na = TRUE)

```

## In the examples below, the mean, standard deviation, and variance are obtained.

```{r}
svymean(~log(monoEthyl), nhc, na = TRUE)
svysd(~log(monoEthyl),design = nhc, na = TRUE)
svyvar(~log(monoEthyl), design = nhc, na = TRUE)

```

## The cv function is used to get the coefficient of variation
The coefficient of variation is the ratio of the standard error to the mean, multiplied by 100%. It is an indication of the variability relative to the mean in the population and is not affected by the unit of measurement of the variable.

```{r}
cv(svymean(~log(monoEthyl),design = nhc, na = TRUE))

```

## Quantiles are a useful descriptive statistic for continuous variables, particularly variables that are not normally distributed.

```{r}
svyquantile(~URXMEP, design = nhc, na = TRUE, c(.25,.5,.75),ci=TRUE)
```

```{r}
svyquantile(~log(monoEthyl), design = nhc, na = TRUE, c(.25,.5,.75),ci=TRUE)
```

## Descriptive statistics for categorical variables

(https://www.rdocumentation.org/packages/survey/versions/4.1-1/topics/svytable)
(https://r-survey.r-forge.r-project.org/survey/html/svychisq.html)

The frequencies in the table can be normalized to some convenient total such as 100 or 1.0 by specifying the Ntotal argument. If the formula has a left-hand side the mean or sum of this variable rather than the frequency is tabulated.

The Ntotal argument can be either a single number or a data frame whose first column gives the (first-stage) sampling strata and second column the population size in each stratum. In this second case the svytable command performs `post-stratification': tabulating and scaling to the population within strata and then adding up the strata.

```{r}
svytable(~fpl, design = nhc, Ntotal = 100)

svytable(~fpl + citizenship, nhc)

svytable(~fpl + citizenship, nhc, Ntotal = 1.0)
```

## Graphing of continuous variables
### Histogram 
By default, the density is shown on the y-axis.

```{r}
svyhist(~log(monoEthyl), nhc)
```

Instead of the density on the y-axis, we can request the count.  

```{r}
svyhist(~log(monoEthyl), nhc, probability = FALSE)
```

```{r}
svyhist(~RIDAGEYR, nhc, probability = FALSE)
```

### Boxplots

```{r}
svyboxplot(~log(monoEthyl)~1, nhc, all.outliers=TRUE)

```

We can break the boxplot by a grouping variable. The grouping variable must be a factor.

```{r}
svyboxplot(~log(monoEthyl)~factor(gender), nhc, all.outliers=TRUE)
```

### Scatterplot
Sampling weights corresponding to the bubble size.

```{r}
svyplot(~log(monoEthyl)+RIDAGEYR, nhc, style="bubble")
```

### Density and smoothed plots

```{r}
smth<-svysmooth(~log(monoEthyl), design=nhc)
plot(smth)
```

```{r}
dens<-svysmooth(~log(monoEthyl), design=nhc,bandwidth=30)
plot(dens)
```

```{r}
dens1<-svysmooth(~log(monoEthyl), design=nhc)
plot(dens1)
```






